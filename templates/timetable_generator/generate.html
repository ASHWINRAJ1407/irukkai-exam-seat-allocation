{% extends "base.html" %}
{% block title %}Generate Timetable - ESAL{% endblock %}
{% block content %}
<div class="mb-4">
    <a href="{{ url_for('timetable_generator.index') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-1"></i>Back</a>
</div>

<div class="card mb-4">
    <div class="card-header"><i class="bi bi-list-check me-2"></i>Subject count per department</div>
    <div class="card-body">
        <p class="mb-2">After import, each department has the following number of subjects:</p>
        <p class="mb-0">
            {% for dept, count in counts.items()|sort %}
            <span class="badge bg-primary me-2">{{ dept }} — {{ count }}</span>
            {% endfor %}
        </p>
    </div>
</div>

<div class="card" style="max-width: 600px;">
    <div class="card-header"><i class="bi bi-gear me-2"></i>Step 2 — Set date and timing</div>
    <div class="card-body">
        <form method="post" action="{{ url_for('timetable_generator.generate_form') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label class="form-label">Starting date</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                    <input type="date" name="start_date" class="form-control" required>
                </div>
                <span class="form-text">Pick the first exam date from the calendar.</span>
            </div>
            <div class="mb-3">
                <label class="form-label">Exam timing (12-hour format)</label>
                <div class="mb-3">
                    <label class="form-label">Batch</label>
                    <select name="academic_year" class="form-select mb-2">
                        {% if batches %}
                            {% for b in batches %}
                                <option value="{{ b }}" {% if b == academic_year %}selected{% endif %}>{{ b }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="{{ academic_year }}">{{ academic_year }}</option>
                        {% endif %}
                    </select>
                </div>
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-clock"></i></span>
                            <select class="form-select" id="start_hour" required>
                                {% for h in range(1, 13) %}
                                <option value="{{ '%02d' % h }}">{{ '%02d' % h }}</option>
                                {% endfor %}
                            </select>
                            <select class="form-select" id="start_minute" required>
                                {% for m in range(0, 60) %}
                                <option value="{{ '%02d' % m }}">{{ '%02d' % m }}</option>
                                {% endfor %}
                            </select>
                            <select class="form-select" id="start_ampm" required>
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                        </div>
                        <span class="form-text">Start time (HH:MM AM/PM)</span>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-clock-history"></i></span>
                            <select class="form-select" id="end_hour" required>
                                {% for h in range(1, 13) %}
                                <option value="{{ '%02d' % h }}">{{ '%02d' % h }}</option>
                                {% endfor %}
                            </select>
                            <select class="form-select" id="end_minute" required>
                                {% for m in range(0, 60) %}
                                <option value="{{ '%02d' % m }}">{{ '%02d' % m }}</option>
                                {% endfor %}
                            </select>
                            <select class="form-select" id="end_ampm" required>
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                        </div>
                        <span class="form-text">End time (HH:MM AM/PM)</span>
                    </div>
                </div>
                <input type="hidden" name="exam_start_time" id="exam_start_time">
                <input type="hidden" name="exam_end_time" id="exam_end_time">
                <span class="form-text">Same timing is applied to all exams. Times will be shown in PDFs as 12-hour with AM/PM.</span>
            </div>
            <div class="mb-4">
                <label class="form-label">Excluded dates</label>
                <div id="excluded-dates">
                    <div class="input-group mb-2">
                        <span class="input-group-text"><i class="bi bi-calendar2-x"></i></span>
                        <input type="date" name="excluded_date" class="form-control" value="">
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="add-excluded"><i class="bi bi-plus me-1"></i>Add another excluded date</button>
            </div>
            <button type="submit" class="btn btn-primary"><i class="bi bi-cpu me-1"></i>Generate timetable</button>
        </form>
    </div>
</div>

<script>
(function() {
    // Dynamic excluded dates
    var container = document.getElementById('excluded-dates');
    var addBtn = document.getElementById('add-excluded');
    addBtn.addEventListener('click', function() {
        var div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = '<span class="input-group-text"><i class="bi bi-calendar2-x"></i></span><input type="date" name="excluded_date" class="form-control">';
        container.appendChild(div);
    });

    // Build 12-hour time strings into hidden inputs before submit
    var form = document.querySelector('form');
    form.addEventListener('submit', function() {
        function buildTime(hourId, minuteId, ampmId) {
            var h = document.getElementById(hourId).value || '01';
            var m = document.getElementById(minuteId).value || '00';
            var ap = document.getElementById(ampmId).value || 'AM';
            return h + ':' + m + ' ' + ap;
        }
        document.getElementById('exam_start_time').value = buildTime('start_hour', 'start_minute', 'start_ampm');
        document.getElementById('exam_end_time').value = buildTime('end_hour', 'end_minute', 'end_ampm');
    });
})();
</script>
{% endblock %}
