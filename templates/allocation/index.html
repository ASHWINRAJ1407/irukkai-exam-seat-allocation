{% extends "base.html" %}
{% block title %}Seat Allocation - Exam Seat Allocation{% endblock %}
{% block content %}
<h1 class="page-title"><i class="bi bi-layout-text-sidebar-reverse me-2"></i>Seat Allocation</h1>

<p class="text-muted mb-4">Select an exam date to view or generate seat allocations. Each day shows departments, participating students, and available seats.</p>

{% if daily_exams %}
<div class="row g-4">
    {% for item in daily_exams %}
    <div class="col-12">
        <div class="card h-100">
            <div class="card-body">
                <h2 class="card-title h4 mb-3">{{ item.exam_name }}</h2>
                <p class="text-muted mb-3"><i class="bi bi-calendar-date me-1"></i>Date: {{ item.exam_date }}</p>
                <div class="row g-2 mb-2">
                    <div class="col-auto"><span class="badge bg-primary">Departments: {{ item.departments_count }}</span></div>
                    <div class="col-auto"><span class="badge bg-success">Students: {{ item.total_students }}</span></div>
                    <div class="col-auto"><span class="badge bg-info">Available seats: {{ item.available_seats }}</span></div>
                </div>
                {% set rooms_needed = item.rooms_needed_for_allocation %}
                {% set required_seats = item.required_seats %}
                <p class="mb-2 small text-muted">
                    <strong>Rooms needed for allocation:</strong>
                    ceiling(no. of students / seat capacity (default 45)) - rooms allocated
                    = ceiling({{ item.total_students }} / 45) - {{ item.rooms_allocated }} =
                    <span class="{{ rooms_needed > 0 and 'text-danger fw-bold' or 'fw-bold' }}">{{ rooms_needed }}</span>
                </p>
                {% if required_seats > 0 %}
                <p class="mb-2 small text-danger">
                    <strong>Required seats:</strong>
                    no. of students - available seats
                    = {{ item.total_students }} - {{ item.available_seats }} =
                    <span class="fw-bold">{{ required_seats }}</span>
                </p>
                <p class="mb-3 text-danger small">
                    Allocation cannot be generated until additional halls are added to cover the missing seats.
                </p>
                {% endif %}
                <div class="d-flex gap-2">
                    {% set disable_allocation = required_seats > 0 %}
                    <a href="{{ url_for('allocation.view', exam_id=item.exam_id, exam_date=item.exam_date) }}"
                       class="btn btn-outline-primary {% if disable_allocation %}disabled{% endif %}"
                       {% if disable_allocation %}tabindex="-1" aria-disabled="true" onclick="return false;"{% endif %}>
                        <i class="bi bi-eye me-1"></i>View Allocation
                    </a>
                    <a href="{{ url_for('allocation.generate', exam_id=item.exam_id, exam_date=item.exam_date) }}"
                       class="btn btn-primary {% if disable_allocation %}disabled{% endif %}"
                       {% if disable_allocation %}tabindex="-1" aria-disabled="true" onclick="return false;"{% endif %}>
                        <i class="bi bi-file-pdf me-1"></i>Generate Allocation
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-calendar-x display-4 text-muted"></i>
        <p class="text-muted mt-3">No upcoming exams with schedules. Create exam schedules first.</p>
        <a href="{{ url_for('exam_schedule.index') }}" class="btn btn-primary"><i class="bi bi-calendar-plus me-1"></i>Go to Exam Schedule</a>
    </div>
</div>
{% endif %}
{% endblock %}
